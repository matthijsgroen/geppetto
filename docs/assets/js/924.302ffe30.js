(self.webpackChunkgeppetto=self.webpackChunkgeppetto||[]).push([[924],{1262:(t,e,n)=>{"use strict";n.d(e,{Z:()=>a});var r=n(7294),o=n(2389);function a(t){let{children:e,fallback:n}=t;return(0,o.Z)()?r.createElement(r.Fragment,null,null==e?void 0:e()):null!=n?n:null}},6618:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>a});const r=Math.pow(2,-52),o=new Uint32Array(512);class a{static from(t,e=d,n=m){const r=t.length,o=new Float64Array(2*r);for(let a=0;a<r;a++){const r=t[a];o[2*a]=e(r),o[2*a+1]=n(r)}return new a(o)}constructor(t){const e=t.length>>1;if(e>0&&"number"!=typeof t[0])throw new Error("Expected coords to contain numbers.");this.coords=t;const n=Math.max(2*e-5,0);this._triangles=new Uint32Array(3*n),this._halfedges=new Int32Array(3*n),this._hashSize=Math.ceil(Math.sqrt(e)),this._hullPrev=new Uint32Array(e),this._hullNext=new Uint32Array(e),this._hullTri=new Uint32Array(e),this._hullHash=new Int32Array(this._hashSize).fill(-1),this._ids=new Uint32Array(e),this._dists=new Float64Array(e),this.update()}update(){const{coords:t,_hullPrev:e,_hullNext:n,_hullTri:o,_hullHash:a}=this,s=t.length>>1;let c=1/0,h=1/0,d=-1/0,m=-1/0;for(let r=0;r<s;r++){const e=t[2*r],n=t[2*r+1];e<c&&(c=e),n<h&&(h=n),e>d&&(d=e),n>m&&(m=n),this._ids[r]=r}const g=(c+d)/2,p=(h+m)/2;let v,E,_,T=1/0;for(let r=0;r<s;r++){const e=i(g,p,t[2*r],t[2*r+1]);e<T&&(v=r,T=e)}const y=t[2*v],x=t[2*v+1];T=1/0;for(let r=0;r<s;r++){if(r===v)continue;const e=i(y,x,t[2*r],t[2*r+1]);e<T&&e>0&&(E=r,T=e)}let M=t[2*E],A=t[2*E+1],w=1/0;for(let r=0;r<s;r++){if(r===v||r===E)continue;const e=u(y,x,M,A,t[2*r],t[2*r+1]);e<w&&(_=r,w=e)}let b=t[2*_],L=t[2*_+1];if(w===1/0){for(let r=0;r<s;r++)this._dists[r]=t[2*r]-t[0]||t[2*r+1]-t[1];f(this._ids,this._dists,0,s-1);const e=new Uint32Array(s);let n=0;for(let t=0,r=-1/0;t<s;t++){const o=this._ids[t];this._dists[o]>r&&(e[n++]=o,r=this._dists[o])}return this.hull=e.subarray(0,n),this.triangles=new Uint32Array(0),void(this.halfedges=new Uint32Array(0))}if(l(y,x,M,A,b,L)){const t=E,e=M,n=A;E=_,M=b,A=L,_=t,b=e,L=n}const R=function(t,e,n,r,o,a){const i=n-t,s=r-e,l=o-t,c=a-e,u=i*i+s*s,f=l*l+c*c,h=.5/(i*c-s*l);return{x:t+(c*u-s*f)*h,y:e+(i*f-l*u)*h}}(y,x,M,A,b,L);this._cx=R.x,this._cy=R.y;for(let r=0;r<s;r++)this._dists[r]=i(t[2*r],t[2*r+1],R.x,R.y);f(this._ids,this._dists,0,s-1),this._hullStart=v;let S=3;n[v]=e[_]=E,n[E]=e[v]=_,n[_]=e[E]=v,o[v]=0,o[E]=1,o[_]=2,a.fill(-1),a[this._hashKey(y,x)]=v,a[this._hashKey(M,A)]=E,a[this._hashKey(b,L)]=_,this.trianglesLen=0,this._addTriangle(v,E,_,-1,-1,-1);for(let i,u,f=0;f<this._ids.length;f++){const s=this._ids[f],c=t[2*s],h=t[2*s+1];if(f>0&&Math.abs(c-i)<=r&&Math.abs(h-u)<=r)continue;if(i=c,u=h,s===v||s===E||s===_)continue;let d=0;for(let t=0,e=this._hashKey(c,h);t<this._hashSize&&(d=a[(e+t)%this._hashSize],-1===d||d===n[d]);t++);d=e[d];let m,g=d;for(;m=n[g],!l(c,h,t[2*g],t[2*g+1],t[2*m],t[2*m+1]);)if(g=m,g===d){g=-1;break}if(-1===g)continue;let p=this._addTriangle(g,s,n[g],-1,-1,o[g]);o[s]=this._legalize(p+2),o[g]=p,S++;let T=n[g];for(;m=n[T],l(c,h,t[2*T],t[2*T+1],t[2*m],t[2*m+1]);)p=this._addTriangle(T,s,m,o[s],-1,o[T]),o[s]=this._legalize(p+2),n[T]=T,S--,T=m;if(g===d)for(;m=e[g],l(c,h,t[2*m],t[2*m+1],t[2*g],t[2*g+1]);)p=this._addTriangle(m,s,g,-1,o[g],o[m]),this._legalize(p+2),o[m]=p,n[g]=g,S--,g=m;this._hullStart=e[s]=g,n[g]=e[T]=s,n[s]=T,a[this._hashKey(c,h)]=s,a[this._hashKey(t[2*g],t[2*g+1])]=g}this.hull=new Uint32Array(S);for(let r=0,i=this._hullStart;r<S;r++)this.hull[r]=i,i=n[i];this.triangles=this._triangles.subarray(0,this.trianglesLen),this.halfedges=this._halfedges.subarray(0,this.trianglesLen)}_hashKey(t,e){return Math.floor(function(t,e){const n=t/(Math.abs(t)+Math.abs(e));return(e>0?3-n:1+n)/4}(t-this._cx,e-this._cy)*this._hashSize)%this._hashSize}_legalize(t){const{_triangles:e,_halfedges:n,coords:r}=this;let a=0,i=0;for(;;){const s=n[t],l=t-t%3;if(i=l+(t+2)%3,-1===s){if(0===a)break;t=o[--a];continue}const u=s-s%3,f=l+(t+1)%3,h=u+(s+2)%3,d=e[i],m=e[t],g=e[f],p=e[h];if(c(r[2*d],r[2*d+1],r[2*m],r[2*m+1],r[2*g],r[2*g+1],r[2*p],r[2*p+1])){e[t]=p,e[s]=d;const r=n[h];if(-1===r){let e=this._hullStart;do{if(this._hullTri[e]===h){this._hullTri[e]=t;break}e=this._hullPrev[e]}while(e!==this._hullStart)}this._link(t,r),this._link(s,n[i]),this._link(i,h);const l=u+(s+1)%3;a<o.length&&(o[a++]=l)}else{if(0===a)break;t=o[--a]}}return i}_link(t,e){this._halfedges[t]=e,-1!==e&&(this._halfedges[e]=t)}_addTriangle(t,e,n,r,o,a){const i=this.trianglesLen;return this._triangles[i]=t,this._triangles[i+1]=e,this._triangles[i+2]=n,this._link(i,r),this._link(i+1,o),this._link(i+2,a),this.trianglesLen+=3,i}}function i(t,e,n,r){const o=t-n,a=e-r;return o*o+a*a}function s(t,e,n,r,o,a){const i=(r-e)*(o-t),s=(n-t)*(a-e);return Math.abs(i-s)>=33306690738754716e-32*Math.abs(i+s)?i-s:0}function l(t,e,n,r,o,a){return(s(o,a,t,e,n,r)||s(t,e,n,r,o,a)||s(n,r,o,a,t,e))<0}function c(t,e,n,r,o,a,i,s){const l=t-i,c=e-s,u=n-i,f=r-s,h=o-i,d=a-s,m=u*u+f*f,g=h*h+d*d;return l*(f*g-m*d)-c*(u*g-m*h)+(l*l+c*c)*(u*d-f*h)<0}function u(t,e,n,r,o,a){const i=n-t,s=r-e,l=o-t,c=a-e,u=i*i+s*s,f=l*l+c*c,h=.5/(i*c-s*l),d=(c*u-s*f)*h,m=(i*f-l*u)*h;return d*d+m*m}function f(t,e,n,r){if(r-n<=20)for(let o=n+1;o<=r;o++){const r=t[o],a=e[r];let i=o-1;for(;i>=n&&e[t[i]]>a;)t[i+1]=t[i--];t[i+1]=r}else{let o=n+1,a=r;h(t,n+r>>1,o),e[t[n]]>e[t[r]]&&h(t,n,r),e[t[o]]>e[t[r]]&&h(t,o,r),e[t[n]]>e[t[o]]&&h(t,n,o);const i=t[o],s=e[i];for(;;){do{o++}while(e[t[o]]<s);do{a--}while(e[t[a]]>s);if(a<o)break;h(t,o,a)}t[n+1]=t[a],t[a]=i,r-o+1>=a-n?(f(t,e,o,r),f(t,e,n,a-1)):(f(t,e,n,a-1),f(t,e,o,r))}}function h(t,e,n){const r=t[e];t[e]=t[n],t[n]=r}function d(t){return t[0]}function m(t){return t[1]}},2191:(t,e,n)=>{var r=n(6618);function o(t,e,n,r){Object.defineProperty(t,e,{get:n,set:r,enumerable:!0,configurable:!0})}function a(t){return t&&t.__esModule?t.default:t}o(t.exports,"prepareAnimation",(()=>T)),o(t.exports,"createPlayer",(()=>R)),o(t.exports,"setupWebGL",(()=>b));const i=t=>t.reduce(((t,e)=>t.concat(e)),[]),s=t=>({data:new Float32Array(i(t)),length:t.length,stride:void 0===t[0]?0:t[0].length}),l=t=>"folder"===t.type||"sprite"===t.type,c=t=>"deform"===t.type||"rotate"===t.type||"translate"===t.type||"stretch"===t.type||"opacity"===t.type,u=t=>"lightness"===t.type||"saturation"===t.type||"colorize"===t.type,f=(t,e,n=[])=>{for(const r of t){e(r,n);for(const t of r.mutationVectors)e(t,[...n,r]);"folder"===r.type&&f(r.items,e,[...n,r])}},h={translate:1,stretch:2,rotate:3,deform:4,opacity:5,lightness:6,colorize:7,saturation:8},d=(t,e)=>{const n=t[t.length-1];if(l(n)){const r=e?n.mutationVectors.indexOf(e):-1;if(r>0)return n.mutationVectors[r-1];for(let n=t.length-(e?2:1);n>=0;n--){const e=t[n];if(e&&l(e)&&e.mutationVectors.length>0)return e.mutationVectors[e.mutationVectors.length-1]}}return null},m=t=>{const e=[],n=[],r={};f(t,((t,o)=>{if((t=>c(t)||u(t))(t)){const i=[h[(a=t).type],a.origin[0],a.origin[1],"deform"===a.type||"translate"===a.type?a.radius:-1],s=n.length;n.push(i);const l=d(o,t),c=null===l?-1:e.findIndex((t=>t.name===l.name));e.push({name:t.name,index:s,parent:c}),r[t.name]=c}var a}));const o={};f(t,((t,n)=>{if(l(t)){const r=d(n.concat(t)),a=null===r?-1:e.findIndex((t=>t.name===r.name));o[t.name]=a}}));const a=new Int32Array(n.length);return e.forEach(((t,e)=>{a[e]=t.parent})),{mutatorMapping:r,parentList:a,vectorSettings:n,shapeMutatorMapping:o}},g=t=>{const e=t.controls.map((t=>t.name));return t.animations.map((t=>{const n=[],r=[];return t.keyframes.reduce(((t,e)=>(e.event&&r.push([e.time,e.event]),t.concat(Object.keys(e.controlValues)))),[]).filter(((t,e,n)=>n.indexOf(t)===e)).forEach((r=>{const o=[];t.keyframes.forEach((t=>{const e=t.controlValues[r];void 0!==e&&o.push([t.time,e])})),n.push([e.indexOf(r),new Float32Array(i(o))])})),{name:t.name,duration:0===t.keyframes.length?0:t.keyframes[t.keyframes.length-1].time,looping:t.looping,tracks:n,events:r}}))};var p,v;(v=p||(p={}))[v.MULTIPLY=0]="MULTIPLY",v[v.ADD=1]="ADD",v[v.HUE=2]="HUE";const E=t=>t===h.stretch||t===h.lightness||t===h.saturation||t===h.opacity?p.MULTIPLY:t===h.colorize?p.HUE:p.ADD,_=["1.0","1.1"],T=t=>{if(!_.includes(t.version))throw new Error(`Version ${t.version} files are not supported`);const e=[],n=[],o=[];f(t.shapes,(t=>{if("sprite"!==t.type)return;const i=(t=>{let e=1/0,n=-1/0,r=1/0,o=-1/0;return t.points.forEach((([t,a])=>{e=t<e?t:e,n=t>n?t:n,r=a<r?a:r,o=a>o?a:o})),[(e+n)/2,(r+o)/2]})(t),s=(l=t.points,a(r).from(l).triangles);var l;const c=[...t.translate,.1*e.length],u=n.length;e.push({name:t.name,start:2*o.length,amount:s.length,mutator:0,x:c[0],y:c[1],z:1e-4*c[2]-.9}),t.points.forEach((([t,e])=>{n.push([t-i[0],e-i[1],t,e])})),s.forEach((t=>{o.push(t+u)}))}));const i=m(t.shapes),l=i.parentList.length,c=Object.keys(i.mutatorMapping),u=[],h=new Float32Array(2*l);Object.entries(t.defaultFrame).forEach((([t,e])=>{const n=c.indexOf(t);-1!==n&&(h[2*n]=e[0],h[2*n+1]=e[1])}));const d=[],p=[],v=[];e.forEach((t=>{t.mutator=i.shapeMutatorMapping[t.name]})),e.sort(((t,e)=>(e.z||0)-(t.z||0)));const T=new Float32Array(t.controls.length),y=t.controls.reduce(((e,n,r)=>{const o=n.steps.reduce(((t,e)=>t.concat(Object.keys(e).filter((e=>!t.includes(e))))),[]);return u.push({name:n.name,steps:n.steps.length}),T[r]=t.controlValues[n.name],o.forEach((r=>{const o=c.indexOf(r),a=n.steps.map((t=>t[r])),i=(null==t?void 0:t.controls.findIndex((t=>t.name===n.name)))||0,s={name:n.name,controlIndex:i,valueStartIndex:0,values:a,stepType:0};e={...e,[o]:(e[o]||[]).concat(s)}})),e}),{});v.length=i.vectorSettings.length,v.fill([0,0]);let x=0;const M=[];return Object.entries(y).forEach((([t,e])=>{const n=parseInt(t,10);if(1===e.length){const t=e[0],r=i.vectorSettings[n][0];return void M.push({mutation:n,mixMode:E(r),control:t.controlIndex,stepType:t.stepType,trackX:new Float32Array(t.values.reduce(((t,e,n)=>t.concat(n,e[0])),[])),trackY:new Float32Array(t.values.reduce(((t,e,n)=>t.concat(n,e[1])),[]))})}if(0===e.length)return;for(const o of e)o.valueStartIndex=d.length,d.push(...o.values);const r=e.map((t=>[t.valueStartIndex,t.controlIndex,t.stepType]));v[n]=[p.length,r.length],x=Math.max(x,r.length),p.push(...r)})),{directControls:M,mutators:s(i.vectorSettings),mutatorParents:{data:i.parentList,length:i.parentList.length,stride:1},mutationValues:{data:h,length:i.parentList.length,stride:2},controlMutationValues:s(d),mutationValueIndices:s(p),controlMutationIndices:s(v),defaultControlValues:T,shapeVertices:s(n),shapeIndices:new Uint16Array(o),shapes:e,controls:u,maxIteration:x,animations:g(t)}};const y=(t,e,n)=>t*(1-n)+e*n,x=(t,e,n)=>{const r=Math.abs(t-e);let o=t,a=e;return t<e&&Math.abs(t+1-e)<r&&(o+=1),t>e&&Math.abs(e-t+1)<r&&(a+=1),y(o,a,n)%1},M=(t,e,n=0,r=y)=>{for(let o=0;o<t.length;o+=2)if(t[o]>e){const a=o>1?t[o-2]:0,i=o>1?t[o-1]:n,s=(e-a)/(t[o]-a);return r(i,t[o+1],s)}return t[t.length-1]},A={zoom:1,panX:0,panY:0,zIndex:0},w=t=>{const e=t.getContext("webgl",{premultipliedalpha:!0,depth:!0,antialias:!0,powerPreference:"low-power"});if(!e)throw new Error("Canvas has no webgl context available");return e},b=t=>{const e=w(t);return e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),R(t)},L=(t,e)=>{const n=t.createProgram();if(!n)throw new Error("Failed to create shader program");const r=(t=>`\n#define MAX_MUT ${t.mutators.length}\n#define MAX_IT ${t.maxIteration}\nuniform vec2 uControlMutValues[${t.controlMutationValues.length}];\nuniform vec3 uMutValueIndices[${t.mutationValueIndices.length}];\nuniform vec2 uControlMutIndices[${t.controlMutationIndices.length}];\nuniform float uControlValues[${t.controls.length}];\n${a("#define GLSLIFY 1\n#define A 0.017453292519943295\nuniform vec2 viewport;uniform vec3 basePosition;uniform vec3 translate;uniform float mutation;uniform vec4 scale;uniform vec2 uMutValues[MAX_MUT];uniform vec4 uMutVectors[MAX_MUT];uniform int uMutParent[MAX_MUT];attribute vec2 coordinates;attribute vec2 aTextureCoord;varying lowp vec2 vTextureCoord;varying lowp float vOpacity;varying lowp float vBrightness;varying lowp float vSaturation;varying lowp float vTargetHue;varying lowp float vTargetSaturation;mat4 B=mat4(2./viewport.x,0,0,0,0,-2./viewport.y,0,0,0,0,1,0,-1,+1,0,1);float C(float D,float E,float F){float G=abs(D-E);float H=D;float I=E;if(D<E&&abs(D+1.-E)<G){H=D+1.;}if(D>E&&abs(E-D+1.)<G){I=E+1.;}return mod(mix(H,I,F),1.);}vec2 J(int K,int L){vec2 M=uMutValues[K];vec2 N=uControlMutIndices[K];int O=int(N.x);int P=int(N.y);if(P==0){return M;}for(int Q=0;Q<MAX_IT;Q++){if(Q<P){vec3 R=uMutValueIndices[O+Q];float S=uControlValues[int(R.y)];int T=int(floor(R.x+S));int U=int(ceil(R.x+S));float V=S-floor(S);vec2 W=uControlMutValues[T];vec2 X=uControlMutValues[U];vec2 Y=mix(W,X,V);if(L==2||L==5||L==6||L==8){M*=Y;}else if(L==7){M=vec2(C(W[0],X[0],V),Y[1]);}else{M+=Y;}}else{return M;}}return M;}mat3 Z(mat3 a,int K){vec4 mutation=uMutVectors[K];int L=int(mutation.x);vec2 b=J(K,L);vec2 c=mutation.yz;vec3 M=a[0];vec3 d=a[1];vec3 e=a[2];if(L==1){float e=1.;if(mutation.a>0.&&distance(M.xy,c)>mutation.a){e=0.;}M=vec3(M.xy+b*e,M.z);}if(L==2){M=vec3(c.xy+vec2((M.x-c.x)*b.x,(M.y-c.y)*b.y),M.z);}if(L==3){float f=b.x*A;mat2 g=mat2(cos(f),sin(f),-sin(f),cos(f));M=vec3((M.xy-c)*g+c,M.z);}if(L==4){float e=1.-clamp(distance(M.xy,c),0.,mutation.a)/mutation.a;M=vec3(M.xy+b*e,M.z);}if(L==5){M=vec3(M.xy,M.z*b.x);}if(L==6){d=vec3(b.x*d.x,d.yz);}if(L==7){e=vec3(b.xy,e.z);}if(L==8){d=vec3(d.x,b.x*d.y,d.z);}return mat3(M,d,e);}mat3 h(mat3 a,int K){int i=K;mat3 M=a;for(int Q=0;Q<MAX_MUT;Q++){if(i==-1){return M;}M=Z(M,i);i=uMutParent[i];}return M;}void main(){mat3 O=mat3(coordinates+translate.xy,1.,1.,1.,0,0,0,0);mat3 j=h(O,int(mutation));vec3 k=j[0];vec3 l=j[1];vec3 m=j[2];vec4 n=B*vec4((k.xy+basePosition.xy)*scale.x,translate.z-basePosition.z,1.);gl_Position=vec4((n.xy+scale.ba)*scale.y,n.z,1.);vTextureCoord=aTextureCoord.xy;vOpacity=k.z;vBrightness=l.x;vSaturation=l.y;vTargetHue=m.x;vTargetSaturation=m.y;}")}\n`)(e),o=t.createShader(t.VERTEX_SHADER),i=t.createShader(t.FRAGMENT_SHADER);if(!o||!i)throw t.deleteProgram(n),t.deleteShader(o),t.deleteShader(i),new Error("Failed to create shader program");if(t.shaderSource(o,r),t.shaderSource(i,a("precision mediump float;\n#define GLSLIFY 1\nvarying mediump vec2 vTextureCoord;varying lowp float vOpacity;varying lowp float vBrightness;varying lowp float vSaturation;varying lowp float vTargetHue;varying lowp float vTargetSaturation;uniform sampler2D uSampler;uniform mediump vec2 uTextureDimensions;float A(vec3 B){lowp float C=min(min(B.r,B.g),B.b);lowp float D=max(max(B.r,B.g),B.b);return(D+C)/2.;}float E(lowp float F,lowp float G,lowp float H){if(H<0.)H+=1.;else if(H>1.)H-=1.;lowp float I;if((6.*H)<1.)I=F+(G-F)*6.*H;else if((2.*H)<1.)I=G;else if((3.*H)<2.)I=F+(G-F)*((2./3.)-H)*6.;else I=F;return I;}vec3 J(vec3 K){lowp vec3 L;if(K.y==0.)L=vec3(K.z);else{lowp float G;if(K.z<0.5)G=K.z*(1.+K.y);else G=(K.z+K.y)-(K.y*K.z);float F=2.*K.z-G;L.r=E(F,G,K.x+(1./3.));L.g=E(F,G,K.x);L.b=E(F,G,K.x-(1./3.));}return L;}void main(void){highp vec2 M=vTextureCoord.xy/uTextureDimensions;mediump vec4 N=texture2D(uSampler,M);vec3 B=N.rgb;float O=A(B);B=mix(mix(B,J(vec3(vTargetHue,vTargetSaturation,O)),1.-vSaturation)*clamp(vBrightness,0.,1.),vec3(1.,1.,1.),clamp(vBrightness-1.,0.,1.));gl_FragColor=vec4(B*N.a*vOpacity,N.a*vOpacity);}")),t.compileShader(o),t.compileShader(i),t.attachShader(n,o),t.attachShader(n,i),t.linkProgram(n),!t.getProgramParameter(n,t.LINK_STATUS))throw console.error("Link failed: "+t.getProgramInfoLog(n)),console.error("vs info-log: "+t.getShaderInfoLog(o)),console.error("fs info-log: "+t.getShaderInfoLog(i)),new Error("Could not initialise shaders");return[n,o,i]},R=t=>{const e=w(t),n=[];let r=[],o=[];return{render:()=>{e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.viewport(0,0,t.width,t.height)},addAnimation:(a,i,s,l)=>{const c=[e.TEXTURE0,e.TEXTURE1,e.TEXTURE2,e.TEXTURE3,e.TEXTURE4,e.TEXTURE5,e.TEXTURE6,e.TEXTURE7,e.TEXTURE8,e.TEXTURE9][s],[u,f,h]=L(e,a);e.useProgram(u);const d=((t,e,n)=>{const r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),t.useProgram(e),t.uniform2f(t.getUniformLocation(e,"uTextureDimensions"),n.width,n.height),r})(e,u,i),m=e.getUniformLocation(u,"uMutParent");e.uniform1iv(m,a.mutatorParents.data);const g=((t,e)=>(n,r)=>{const o=t.getUniformLocation(e,n),a=r.stride;return 2==a?t.uniform2fv(o,r.data):3==a?t.uniform3fv(o,r.data):4==a&&t.uniform4fv(o,r.data),o})(e,u),v=g("uMutValues",a.mutationValues);g("uMutVectors",a.mutators),g("uControlMutValues",a.controlMutationValues),g("uMutValueIndices",a.mutationValueIndices),g("uControlMutIndices",a.controlMutationIndices);const E=e.getUniformLocation(u,"uControlValues");e.uniform1fv(E,a.defaultControlValues);const _=new Float32Array(a.defaultControlValues),T=new Float32Array(a.defaultControlValues),y=e.createBuffer(),w=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferData(e.ARRAY_BUFFER,a.shapeVertices.data,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,w),e.bufferData(e.ELEMENT_ARRAY_BUFFER,a.shapeIndices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);const b=e.getUniformLocation(u,"basePosition"),R=e.getUniformLocation(u,"translate"),S=e.getUniformLocation(u,"mutation"),U=e.getUniformLocation(u,"viewport"),I=e.getUniformLocation(u,"scale"),F=e.getAttribLocation(u,"coordinates"),P=e.getAttribLocation(u,"aTextureCoord");let V=0,B=0,{zoom:D,panX:k,panY:C,zIndex:z}={...A,...l},X=[0,0],O=1;const K=[],N=a.animations.map((t=>t.name)),H=a.controls.map((t=>t.name)),G=a.animations.map((t=>t.looping)),Y=t=>{const e=K.findIndex((e=>e.name===t));if(-1===e)return;const n=K[e];let o=+new Date-n.startedAt+n.startAt;const i=a.animations[n.index];G[n.index]&&(o%=i.duration),K.splice(e,1);for(const[r,a]of i.tracks){const t=M(a,o,_[r]);_[r]=t}for(const a of r)a(t)},$=t=>{const e=H.indexOf(t);if(-1===e)throw new Error(`Control ${t} does not exist in ${H.join(",")}`);return e},j=t=>{const e=N.indexOf(t);if(-1===e)throw new Error(`Track ${t} does not exist in ${N.join(",")}`);return e},Q={destroy(){e.deleteShader(f),e.deleteShader(h),e.deleteProgram(u),e.deleteTexture(d),e.deleteBuffer(y),e.deleteBuffer(w),n.splice(n.indexOf(Q),1)},setLooping(t,e){const n=j(e);G[n]=t},startTrack(t,{startAt:e=0,speed:n=1}={}){const r=j(t),o=a.animations[r].tracks.map((([t])=>t));for(const i of K){a.animations[i.index].tracks.some((([t])=>o.includes(t)))&&Y(N[i.index])}K.push({name:t,index:r,startAt:e,speed:n,startedAt:+new Date,iterationStartedAt:+new Date-e/n,lastRender:0})},stopTrack:Y,setControlValue:(t,e)=>{const n=$(t),r=a.controls[n].steps-1;if(e<0||e>r)throw new Error(`Control ${t} value shoulde be between 0 and ${r}. ${e} is out of bounds.`);for(const o of K){a.animations[o.index].tracks.some((([t])=>t===n))&&Y(N[o.index])}_[n]=e,T[n]=e},getControlValue:t=>_[$(t)],setPanning(t,e){k=t,C=e},setZoom(t){D=t},setZIndex(t){z=t},render(){if(e.useProgram(u),e.bindBuffer(e.ARRAY_BUFFER,y),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,w),e.vertexAttribPointer(F,2,e.FLOAT,!1,4*Float32Array.BYTES_PER_ELEMENT,0),e.enableVertexAttribArray(F),e.vertexAttribPointer(P,2,e.FLOAT,!1,4*Float32Array.BYTES_PER_ELEMENT,2*Float32Array.BYTES_PER_ELEMENT),e.enableVertexAttribArray(P),t.width!==V||t.height!==B){const n=t.width,r=t.height,o=i.width/n>i.height/r;O=o?n/i.width:r/i.height,e.uniform2f(U,n,r),X=[n/2/O,r/2/O],V=t.width,B=t.height}e.uniform4f(I,O,D,k,C),e.activeTexture(c),e.bindTexture(e.TEXTURE_2D,d),e.uniform1i(e.getUniformLocation(u,"uSampler"),s),e.uniform3f(b,X[0],X[1],.01*z);const n=+new Date;for(const t of K){const e=(n-t.iterationStartedAt)*t.speed,r=a.animations[t.index],i=e%r.duration;if(r.duration<e){if(!G[t.index]){Y(r.name);continue}t.iterationStartedAt=n-i;for(const[t]of r.tracks)_[t]=T[t]}for(const[a,s]of r.events){const e=t.iterationStartedAt+a/t.speed;if(e<n&&e>t.lastRender)for(const n of o)n(s,t.name,a)}t.lastRender=n;for(const[t,n]of r.tracks){const e=M(n,i,_[t]);T[t]=e}}const r=Float32Array.from(a.mutationValues.data);for(const t of a.directControls){const e=T[t.control],n=M(t.trackX,e),o=M(t.trackY,e);if(t.mixMode===p.MULTIPLY)r[2*t.mutation]*=n,r[2*t.mutation+1]*=o;else if(t.mixMode===p.ADD)r[2*t.mutation]+=n,r[2*t.mutation+1]+=o;else{const n=M(t.trackX,e,0,x);r[2*t.mutation]=n,r[2*t.mutation+1]*=o}}e.uniform2fv(v,r),e.uniform1fv(E,T);for(const t of a.shapes)e.uniform3f(R,t.x,t.y,t.z),e.uniform1f(S,t.mutator),e.drawElements(e.TRIANGLES,t.amount,e.UNSIGNED_SHORT,t.start)},onTrackStopped:t=>(r=r.concat(t),()=>{r=r.filter((e=>e!==t))}),onEvent:t=>(o=o.concat(t),()=>{o=o.filter((e=>e!==t))})};return n.push(Q),Q},destroy(){for(const t of n)t.destroy();n.length=0}}}}}]);